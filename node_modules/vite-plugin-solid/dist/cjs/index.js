'use strict';

var core = require('@babel/core');

function solidPlugin(options = {}) {
  let needHmr = false;
  return {
    name: 'solid',

    config(_, {
      command
    }) {
      const replaceDev = options.dev !== false;
      const alias = command === 'serve' && replaceDev ? [{
        find: /^solid-js$/,
        replacement: 'solid-js/dev'
      }] : [];
      return {
        /**
         * We only need esbuild on .ts or .js files.
         * .tsx & .jsx files are handled by us
         */
        esbuild: {
          include: /\.ts$/
        },
        resolve: {
          dedupe: ['solid-js', 'solid-js/web'],
          alias
        },
        optimizeDeps: {
          include: ['solid-js/dev', 'solid-js/web']
        }
      };
    },

    configResolved(config) {
      needHmr = config.command === 'serve' && !config.isProduction;
    },

    async transform(source, id, ssr) {
      if (!/\.[jt]sx/.test(id)) return null;
      let solidOptions;

      if (options.ssr) {
        if (ssr) {
          solidOptions = {
            generate: 'ssr',
            hydratable: true
          };
        } else {
          solidOptions = {
            generate: 'dom',
            hydratable: true
          };
        }
      } else {
        solidOptions = {
          generate: 'dom',
          hydratable: false
        };
      }

      const opts = {
        filename: id,
        presets: [[require('babel-preset-solid'), solidOptions]]
      };

      if (id.includes('tsx')) {
        opts.presets.push(require('@babel/preset-typescript'));
      }

      const {
        code,
        map
      } = await core.transformAsync(source, opts);
      if (!needHmr) return {
        code,
        map
      };
      /**
       * TODO: We want to inject HMR runtime here when we know how to do it
       *
       * Couple of ressources:
       * - [vue jsx](https://github.com/vitejs/vite/blob/main/packages/plugin-vue-jsx/index.js#L61)
       * - [solid hmr brainstorm](https://github.com/ryansolid/solid/issues/263)
       * - [solid hmr for wbepack](https://github.com/ryansolid/solid-hot-loader/blob/master/index.js#L5)
       * - [react guide for fast refresh](https://github.com/facebook/react/issues/16604#issuecomment-528663101)
       * - [react fast refresh detection mechanism](https://github.com/facebook/react/blob/master/packages/react-refresh/src/ReactFreshRuntime.js#L696)
       */

      return {
        code,
        map
      };
    }

  };
}

module.exports = solidPlugin;
//# sourceMappingURL=index.js.map
