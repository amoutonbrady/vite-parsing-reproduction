{"version":3,"file":"index.js","sources":["../../src/index.ts"],"sourcesContent":["import { Plugin } from 'vite';\nimport { transformAsync, TransformOptions } from '@babel/core';\n\ninterface Options {\n  dev: boolean;\n  ssr: boolean;\n}\n\nexport default function solidPlugin(options: Partial<Options> = {}): Plugin {\n  let needHmr = false;\n\n  return {\n    name: 'solid',\n\n    config(_, { command }) {\n      const replaceDev = options.dev !== false;\n\n      const alias =\n        command === 'serve' && replaceDev\n          ? [{ find: /^solid-js$/, replacement: 'solid-js/dev' }]\n          : [];\n\n      return {\n        /**\n         * We only need esbuild on .ts or .js files.\n         * .tsx & .jsx files are handled by us\n         */\n        esbuild: { include: /\\.ts$/ },\n        resolve: {\n          dedupe: ['solid-js', 'solid-js/web'],\n          alias,\n        },\n        optimizeDeps: {\n          include: ['solid-js/dev', 'solid-js/web'],\n        },\n      };\n    },\n\n    configResolved(config) {\n      needHmr = config.command === 'serve' && !config.isProduction;\n    },\n\n    async transform(source, id, ssr) {\n      if (!/\\.[jt]sx/.test(id)) return null;\n\n      let solidOptions: { generate: 'ssr' | 'dom'; hydratable: boolean };\n\n      if (options.ssr) {\n        if (ssr) {\n          solidOptions = { generate: 'ssr', hydratable: true };\n        } else {\n          solidOptions = { generate: 'dom', hydratable: true };\n        }\n      } else {\n        solidOptions = { generate: 'dom', hydratable: false };\n      }\n\n      const opts: TransformOptions = {\n        filename: id,\n        presets: [[require('babel-preset-solid'), solidOptions]],\n      };\n\n      if (id.includes('tsx')) {\n        opts.presets.push(require('@babel/preset-typescript'));\n      }\n\n      const { code, map } = await transformAsync(source, opts);\n\n      if (!needHmr) return { code, map };\n\n      /**\n       * TODO: We want to inject HMR runtime here when we know how to do it\n       *\n       * Couple of ressources:\n       * - [vue jsx](https://github.com/vitejs/vite/blob/main/packages/plugin-vue-jsx/index.js#L61)\n       * - [solid hmr brainstorm](https://github.com/ryansolid/solid/issues/263)\n       * - [solid hmr for wbepack](https://github.com/ryansolid/solid-hot-loader/blob/master/index.js#L5)\n       * - [react guide for fast refresh](https://github.com/facebook/react/issues/16604#issuecomment-528663101)\n       * - [react fast refresh detection mechanism](https://github.com/facebook/react/blob/master/packages/react-refresh/src/ReactFreshRuntime.js#L696)\n       */\n      return { code, map };\n    },\n  };\n}\n"],"names":["solidPlugin","options","needHmr","name","config","_","command","replaceDev","dev","alias","find","replacement","esbuild","include","resolve","dedupe","optimizeDeps","configResolved","isProduction","transform","source","id","ssr","test","solidOptions","generate","hydratable","opts","filename","presets","require","includes","push","code","map","transformAsync"],"mappings":";;AAQe,SAASA,WAAT,CAAqBC,OAAyB,GAAG,EAAjD,EAA6D;AAC1E,MAAIC,OAAO,GAAG,KAAd;AAEA,SAAO;AACLC,IAAAA,IAAI,EAAE,OADD;;AAGLC,IAAAA,MAAM,CAACC,CAAD,EAAI;AAAEC,MAAAA;AAAF,KAAJ,EAAiB;AACrB,YAAMC,UAAU,GAAGN,OAAO,CAACO,GAAR,KAAgB,KAAnC;AAEA,YAAMC,KAAK,GACTH,OAAO,KAAK,OAAZ,IAAuBC,UAAvB,GACI,CAAC;AAAEG,QAAAA,IAAI,EAAE,YAAR;AAAsBC,QAAAA,WAAW,EAAE;AAAnC,OAAD,CADJ,GAEI,EAHN;AAKA,aAAO;AACL;AACR;AACA;AACA;AACQC,QAAAA,OAAO,EAAE;AAAEC,UAAAA,OAAO,EAAE;AAAX,SALJ;AAMLC,QAAAA,OAAO,EAAE;AACPC,UAAAA,MAAM,EAAE,CAAC,UAAD,EAAa,cAAb,CADD;AAEPN,UAAAA;AAFO,SANJ;AAULO,QAAAA,YAAY,EAAE;AACZH,UAAAA,OAAO,EAAE,CAAC,cAAD,EAAiB,cAAjB;AADG;AAVT,OAAP;AAcD,KAzBI;;AA2BLI,IAAAA,cAAc,CAACb,MAAD,EAAS;AACrBF,MAAAA,OAAO,GAAGE,MAAM,CAACE,OAAP,KAAmB,OAAnB,IAA8B,CAACF,MAAM,CAACc,YAAhD;AACD,KA7BI;;AA+BL,UAAMC,SAAN,CAAgBC,MAAhB,EAAwBC,EAAxB,EAA4BC,GAA5B,EAAiC;AAC/B,UAAI,CAAC,WAAWC,IAAX,CAAgBF,EAAhB,CAAL,EAA0B,OAAO,IAAP;AAE1B,UAAIG,YAAJ;;AAEA,UAAIvB,OAAO,CAACqB,GAAZ,EAAiB;AACf,YAAIA,GAAJ,EAAS;AACPE,UAAAA,YAAY,GAAG;AAAEC,YAAAA,QAAQ,EAAE,KAAZ;AAAmBC,YAAAA,UAAU,EAAE;AAA/B,WAAf;AACD,SAFD,MAEO;AACLF,UAAAA,YAAY,GAAG;AAAEC,YAAAA,QAAQ,EAAE,KAAZ;AAAmBC,YAAAA,UAAU,EAAE;AAA/B,WAAf;AACD;AACF,OAND,MAMO;AACLF,QAAAA,YAAY,GAAG;AAAEC,UAAAA,QAAQ,EAAE,KAAZ;AAAmBC,UAAAA,UAAU,EAAE;AAA/B,SAAf;AACD;;AAED,YAAMC,IAAsB,GAAG;AAC7BC,QAAAA,QAAQ,EAAEP,EADmB;AAE7BQ,QAAAA,OAAO,EAAE,CAAC,CAACC,OAAO,CAAC,oBAAD,CAAR,EAAgCN,YAAhC,CAAD;AAFoB,OAA/B;;AAKA,UAAIH,EAAE,CAACU,QAAH,CAAY,KAAZ,CAAJ,EAAwB;AACtBJ,QAAAA,IAAI,CAACE,OAAL,CAAaG,IAAb,CAAkBF,OAAO,CAAC,0BAAD,CAAzB;AACD;;AAED,YAAM;AAAEG,QAAAA,IAAF;AAAQC,QAAAA;AAAR,UAAgB,MAAMC,cAAc,CAACf,MAAD,EAASO,IAAT,CAA1C;AAEA,UAAI,CAACzB,OAAL,EAAc,OAAO;AAAE+B,QAAAA,IAAF;AAAQC,QAAAA;AAAR,OAAP;AAEd;AACN;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AACM,aAAO;AAAED,QAAAA,IAAF;AAAQC,QAAAA;AAAR,OAAP;AACD;;AAtEI,GAAP;AAwED;;;;"}